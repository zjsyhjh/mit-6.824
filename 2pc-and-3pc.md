### 2PC

2PC是Two-Phase Commit的缩写，即二阶段提交。目前绝大部分关系型数据库采用二阶段提交协议来完成分布式事务处理，利用该协议能够非常方便地完成所有分布式事务参与者的协调，统一决定事务的提交或回滚，从而能够有效地保证分布式数据一致性。二阶段提交协议将事务的提交过程分成了两个阶段来进行处理，其执行流程如下：



**阶段一：提交事务请求（投票阶段）**

1. 事务询问
   - 协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应
2. 执行事务
   - 各参与者阶段执行事务操作，并将Undo和Redo信息记入事务日志中
3. 各参与者向协调者反馈事务询问的响应
   - 如果参与者成功执行了事务操作，就反馈给协调者Yes响应，表示事务可以执行，否则，就反馈给协调者No响应，表示事务不可以执行



**阶段二：执行事务提交（执行阶段）**

在阶段二中，协调者会根据各参与者的反馈情况来决定最终是否可以进行事务提交操作，正常情况下，包含以下两种可能

*执行事务提交*

如果协调者从所有的参与者中获得的反馈都是Yes响应，那么就会执行事务提交

1. 发送提交请求
   - 协调者向所有参与者节点发送Commit请求
2. 事务提交
   - 参与者搜到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放整个事务执行期间占用的事务资源
3. 反馈事务提交结果
   - 参与者在完成事务提交之后，向协调者发送Ack消息
4. 完成事务
   - 协调者接收到所有参与者反馈的Ack消息后，完成事务

*中断事务*

如果任何一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接受所有参与者的反馈消息，那么就会中断事务

1. 发送回滚请求
   - 协调者向所有参与者节点发出Rollback请求
2. 事务回滚
   - 参与者收到Rollback请求之后，会利用其在阶段一中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源
3. 反馈事务回滚结果
   - 参与者在完成事务回滚之后，向协调者发送Ack消息
4. 中断事务
   - 协调者接收到所有参与者反馈的Ack消息后，完成事务中断

