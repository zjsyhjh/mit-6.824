### 2PC

2PC是Two-Phase Commit的缩写，即二阶段提交。目前绝大部分关系型数据库采用二阶段提交协议来完成分布式事务处理，利用该协议能够非常方便地完成所有分布式事务参与者的协调，统一决定事务的提交或回滚，从而能够有效地保证分布式数据一致性。二阶段提交协议将事务的提交过程分成了两个阶段来进行处理，其执行流程如下：



**阶段一：提交事务请求（投票阶段）**

1. 事务询问
   - 协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应
2. 执行事务
   - 各参与者阶段执行事务操作，并将Undo和Redo信息记入事务日志中
3. 各参与者向协调者反馈事务询问的响应
   - 如果参与者成功执行了事务操作，就反馈给协调者Yes响应，表示事务可以执行，否则，就反馈给协调者No响应，表示事务不可以执行



**阶段二：执行事务提交（执行阶段）**

在阶段二中，协调者会根据各参与者的反馈情况来决定最终是否可以进行事务提交操作，正常情况下，包含以下两种可能

*执行事务提交*

如果协调者从所有的参与者中获得的反馈都是Yes响应，那么就会执行事务提交

1. 发送提交请求
   - 协调者向所有参与者节点发送Commit请求
2. 事务提交
   - 参与者搜到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放整个事务执行期间占用的事务资源
3. 反馈事务提交结果
   - 参与者在完成事务提交之后，向协调者发送Ack消息
4. 完成事务
   - 协调者接收到所有参与者反馈的Ack消息后，完成事务

*中断事务*

如果任何一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接受所有参与者的反馈消息，那么就会中断事务

1. 发送回滚请求
   - 协调者向所有参与者节点发出Rollback请求
2. 事务回滚
   - 参与者收到Rollback请求之后，会利用其在阶段一中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源
3. 反馈事务回滚结果
   - 参与者在完成事务回滚之后，向协调者发送Ack消息
4. 中断事务
   - 协调者接收到所有参与者反馈的Ack消息后，完成事务中断



二阶段提交协议的优点在于原理简单，实现方便，其缺点有以下几个方面

- 同步阻塞：二阶段提交协议存在的最明显也是最大的一个问题就是同步阻塞，这会极大地限制分布式系统的性能。在二阶段提交的执行过程中，所有参与该事务操作的逻辑都处于阻塞状态，也就是说，各个参与者在等待其他参与者响应的过程中，将无法进行其他任何操作
- 单点问题：协调者的角色在二阶段提交协议中起到了非常重要的作用，一旦协调者出现问题，那么整个二阶段提交流程将无法运转，更为严重的是，如果协调者在二阶段中出现问题的话，那么其他参与者将会一直处于锁定事务资源的状态，而无法继续完成事务操作
- 数据不一致：在二阶段提交协议的阶段二，即执行事务提交的时候，当协调者向所有的参与者发送commit请求之后，发生了局部网络异常或者协调者在尚未发送完commit请求之前自身发生了崩溃，导致最终只有部分参与者收到了commit请求。于是这部分收到了commit请求的参与者就会进行事务的提交，而其他没有收到commit请求的参与者无法进行事务的提交，于是整个分布式系统便会出现数据不一致现象



### 3PC

3PC是Three-Phase Commit的缩写，即三阶段提交，是2PC的改进版，其将二阶段提交协议的“提交事务请求”过程一分为二，形成了由CanCommit、PreCommit和doCommit三个阶段组成的事务处理协议



**阶段一：CanCommit**

1. 协调者向所有参与者发送一个包含事务内容的canCommit请求，询问是否可以执行事务提交操作，并开始等待各参与者的响应
2. 各参与者向协调者反馈事务询问的响应
   - 参与者在接收到来自协调者的canCommit请求后，正常情况下，如果其自身认为可以顺利执行事务，那么会反馈Yes响应，并进入预备状态，否则反馈No响应



**阶段二：PreCommit**

*执行事务预提交*

如果协调者从所有参与者获得的反馈都是Yes响应，那么就会执行事务预提交

1. 发送预提交请求
   - 协调者向所有参与者阶段发出preCommit请求，并进入Prepared阶段
2. 事务预提交
   - 参与者接收到preCommit请求后，会执行事务操作，并将Undo和Redo信息记录到事务日志中
3. 各参与者向协调者反馈事务执行的响应
   - 如果参与者成功执行了事务操作，那么就会反馈给协调者Ack响应，同时等待最终的指令：提交或终止

*中断事务*

如果任何一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务

1. 发送中断请求
   - 协调者向所有参与者阶段发出abort请求
2. 中断事务
   - 无论是收到来自协调者的abort请求，或者是在等待协调者请求过程中出现超时，参与者都会中断事务



**阶段三：doCommit**

*执行阶段*

1. 发送提交请求
   - 进入这一阶段，假设协调者处于正常工作状态，并且它接收到了来自所有参与者的Ack响应，那么它将从“预提交”状态转换到“提交”状态，并向所有的参与者发送doCommit请求
2. 事务提交
   - 参与者接收到doCommit请求后，会正式执行事务提交操作，并在完成提交之后释放整个事务执行期间占用的事务资源
3. 反馈事务提交结果
   - 参与者在完成事务提交之后，向协调者发送Ack消息
4. 完成事务
   - 协调者接收到所有参与者反馈的Ack消息后，完成事务

*中断事务*

进入这一阶段，如果协调者处于正常工作状态，并且有任一参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务

1. 发送中断请求
   - 协调者向所有参与者阶段发送abort请求
2. 事务回滚
   - 参与者接收到abort请求后，会利用其在阶段二中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源
3. 反馈事务回滚结果
   - 参与者在完成事务回滚之后，向协调者发送Ack消息
4. 中断事务
   - 协调者接收到所有参与者反馈的Ack消息后，中断事务







